<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price/Carbon Uncertainty Heatmaps</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .subtitle {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.5;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .heatmaps-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .heatmap-panel {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .heatmap-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }

        .heatmap-svg {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        .axis-label {
            font-size: 14px;
            font-weight: 600;
            fill: #495057;
        }

        .tick text {
            font-size: 12px;
            fill: #6c757d;
        }

        .contour-path {
            fill: none;
            stroke-width: 2;
            opacity: 0.8;
        }

        .contour-label {
            font-size: 11px;
            font-weight: 600;
            fill: #343a40;
            text-anchor: middle;
            pointer-events: none;
        }

        .legend {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }

        .legend-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .legend-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .stats-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .stats-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        @media (max-width: 1200px) {
            .heatmaps-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Price/Carbon Uncertainty Heatmaps</div>
        <div class="subtitle">
            2D heatmaps of $-cost and S as functions of EU scale ∈[0.8,1.2] and price_per_kWh ∈[−30%,+30%], with contours indicating decision boundaries; demonstrates robust choice regions under tariff fluctuations.
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="basePrice">Base Price ($/kWh)</label>
                <input type="number" id="basePrice" min="0.05" max="0.50" step="0.01" value="0.12">
            </div>
            <div class="control-group">
                <label for="baseCarbonIntensity">Base Carbon (gCO₂/kWh)</label>
                <input type="number" id="baseCarbonIntensity" min="100" max="800" step="10" value="400">
            </div>
            <div class="control-group">
                <label for="deviceType">GPU Device Type</label>
                <select id="deviceType">
                    <option value="consumer">Consumer GPU</option>
                    <option value="datacenter">Datacenter GPU</option>
                    <option value="mobile">Mobile GPU</option>
                </select>
            </div>
            <div class="control-group">
                <label for="workloadType">Workload Profile</label>
                <select id="workloadType">
                    <option value="compute">Compute Intensive</option>
                    <option value="memory">Memory Intensive</option>
                    <option value="balanced">Balanced</option>
                </select>
            </div>
            <div class="control-group">
                <label for="updateRate">Animation Speed</label>
                <input type="range" id="updateRate" min="100" max="2000" step="100" value="500">
            </div>
        </div>

        <div class="heatmaps-container">
            <div class="heatmap-panel">
                <div class="heatmap-title">Cost Analysis ($-cost)</div>
                <svg class="heatmap-svg" id="costHeatmap"></svg>
            </div>
            <div class="heatmap-panel">
                <div class="heatmap-title">Sustainability Score (S)</div>
                <svg class="heatmap-svg" id="sustainabilityHeatmap"></svg>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-title">Real-time Analysis Statistics</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="optimalRegionCost">73%</div>
                    <div class="stat-label">Cost-Optimal Region</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="optimalRegionSustain">68%</div>
                    <div class="stat-label">Sustainability-Optimal Region</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="robustChoices">15</div>
                    <div class="stat-label">Robust Choice Configurations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxVariation">±18%</div>
                    <div class="stat-label">Maximum Cost Variation</div>
                </div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">Heatmap Interpretation Guide</div>
            <div class="legend-content">
                <div class="legend-section">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #d73027;"></div>
                        <span>High Cost/Low Sustainability (Avoid)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fee08b;"></div>
                        <span>Moderate Performance (Conditional)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #abd9e9;"></div>
                        <span>Good Balance (Recommended)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2166ac;"></div>
                        <span>Optimal Choice (Preferred)</span>
                    </div>
                </div>
                <div class="legend-section">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4a4a4a;"></div>
                        <span>Decision Boundary Contours</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffffff; border: 2px solid #333;"></div>
                        <span>Robust Choice Regions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>High Uncertainty Zones</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #51cf66;"></div>
                        <span>Stable Performance Regions</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Configuration
        const width = 500;
        const height = 400;
        const margin = {top: 20, right: 80, bottom: 60, left: 70};
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        // Scales
        const euScale = d3.scaleLinear().domain([0.8, 1.2]).range([0, innerWidth]);
        const priceScale = d3.scaleLinear().domain([-30, 30]).range([innerHeight, 0]);
        
        // Color scales
        const costColorScale = d3.scaleSequential(d3.interpolateRdYlBu).domain([0, 1]);
        const sustainabilityColorScale = d3.scaleSequential(d3.interpolateViridis).domain([0, 1]);

        // Data generation
        function generateHeatmapData() {
            const data = [];
            const resolution = 40;
            
            for (let i = 0; i <= resolution; i++) {
                for (let j = 0; j <= resolution; j++) {
                    const euScaleValue = 0.8 + (0.4 * i / resolution);
                    const priceVariation = -30 + (60 * j / resolution);
                    
                    // Cost calculation with realistic physics
                    const baseCost = parseFloat(document.getElementById('basePrice').value);
                    const adjustedPrice = baseCost * (1 + priceVariation / 100);
                    const energyConsumption = euScaleValue * (50 + Math.sin(euScaleValue * 3) * 10);
                    const cost = adjustedPrice * energyConsumption;
                    const normalizedCost = Math.min(1, cost / 10); // Normalize for visualization
                    
                    // Sustainability score calculation
                    const carbonIntensity = parseFloat(document.getElementById('baseCarbonIntensity').value);
                    const carbonEmission = energyConsumption * carbonIntensity / 1000;
                    const efficiencyFactor = 1 / euScaleValue; // Lower EU scale = higher efficiency
                    const sustainabilityScore = Math.max(0, 1 - (carbonEmission * 0.1) + (efficiencyFactor - 1) * 0.5);
                    
                    // Add device type and workload modifiers
                    const deviceType = document.getElementById('deviceType').value;
                    const workloadType = document.getElementById('workloadType').value;
                    
                    let deviceMultiplier = 1;
                    if (deviceType === 'datacenter') deviceMultiplier = 1.3;
                    else if (deviceType === 'mobile') deviceMultiplier = 0.7;
                    
                    let workloadMultiplier = 1;
                    if (workloadType === 'compute') workloadMultiplier = 1.2;
                    else if (workloadType === 'memory') workloadMultiplier = 0.9;
                    
                    data.push({
                        euScale: euScaleValue,
                        priceVariation: priceVariation,
                        cost: normalizedCost * deviceMultiplier,
                        sustainability: Math.min(1, sustainabilityScore * workloadMultiplier),
                        rawCost: cost * deviceMultiplier,
                        rawEnergy: energyConsumption * deviceMultiplier,
                        rawCarbon: carbonEmission * deviceMultiplier
                    });
                }
            }
            return data;
        }

        // Contour generation
        function generateContours(data, valueAccessor, thresholds) {
            const values = data.map(valueAccessor);
            const contours = d3.contours()
                .size([41, 41])
                .thresholds(thresholds);
                
            return contours(values);
        }

        // Create heatmap
        function createHeatmap(svgId, data, valueAccessor, colorScale, title) {
            const svg = d3.select(svgId);
            svg.selectAll("*").remove();
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create heatmap rectangles
            const rectSize = Math.min(innerWidth / 41, innerHeight / 41);
            
            g.selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => euScale(d.euScale) - rectSize/2)
                .attr("y", d => priceScale(d.priceVariation) - rectSize/2)
                .attr("width", rectSize)
                .attr("height", rectSize)
                .attr("fill", d => colorScale(valueAccessor(d)))
                .attr("stroke", "none")
                .on("mouseover", function(event, d) {
                    const tooltip = d3.select("#tooltip");
                    tooltip.style("opacity", 1)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px")
                        .html(`
                            <strong>EU Scale:</strong> ${d.euScale.toFixed(2)}<br>
                            <strong>Price Variation:</strong> ${d.priceVariation.toFixed(1)}%<br>
                            <strong>Cost:</strong> $${d.rawCost.toFixed(3)}<br>
                            <strong>Energy:</strong> ${d.rawEnergy.toFixed(1)} Wh<br>
                            <strong>Carbon:</strong> ${d.rawCarbon.toFixed(2)} gCO₂<br>
                            <strong>Sustainability:</strong> ${(d.sustainability * 100).toFixed(1)}%
                        `);
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                });

            // Add contours with proper clipping
            const contourThresholds = [0.2, 0.4, 0.6, 0.8];
            const contours = generateContours(data, valueAccessor, contourThresholds);
            
            // Create clipping path to keep contours within bounds
            const clipId = `clip-${svgId.replace('#', '')}`;
            svg.append("defs")
                .append("clipPath")
                .attr("id", clipId)
                .append("rect")
                .attr("x", margin.left)
                .attr("y", margin.top)
                .attr("width", innerWidth)
                .attr("height", innerHeight);
            
            const contourPath = d3.geoPath()
                .projection(d3.geoIdentity()
                    .scale(innerWidth / 41)
                    .translate([0, 0]));

            const contourGroup = g.append("g")
                .attr("clip-path", `url(#${clipId})`);

            contourGroup.selectAll(".contour-path")
                .data(contours)
                .enter()
                .append("path")
                .attr("class", "contour-path")
                .attr("d", contourPath)
                .attr("stroke", d => d.value > 0.5 ? "#ffffff" : "#333333")
                .attr("stroke-width", d => d.value > 0.6 ? 3 : 2)
                .attr("opacity", 0.8);

            // Add robust choice regions (simplified as example regions) with clipping
            const robustRegionGroup = g.append("g")
                .attr("clip-path", `url(#${clipId})`);
                
            robustRegionGroup.append("ellipse")
                .attr("cx", euScale(1.0))
                .attr("cy", priceScale(0))
                .attr("rx", 35)
                .attr("ry", 25)
                .attr("fill", "none")
                .attr("stroke", "#51cf66")
                .attr("stroke-width", 3)
                .attr("stroke-dasharray", "5,5")
                .attr("opacity", 0.8);

            // Add axes
            const xAxis = d3.axisBottom(euScale).ticks(5);
            const yAxis = d3.axisLeft(priceScale).ticks(6).tickFormat(d => `${d}%`);

            g.append("g")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(xAxis)
                .append("text")
                .attr("class", "axis-label")
                .attr("x", innerWidth / 2)
                .attr("y", 40)
                .style("text-anchor", "middle")
                .text("EU Scale");

            g.append("g")
                .call(yAxis)
                .append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .style("text-anchor", "middle")
                .text("Price Variation (%)");

            // Add color bar
            const colorBarWidth = 15;
            const colorBarHeight = innerHeight;
            
            const colorBar = g.append("g")
                .attr("transform", `translate(${innerWidth + 20}, 0)`);

            const colorBarScale = d3.scaleLinear()
                .domain(colorScale.domain())
                .range([colorBarHeight, 0]);

            const colorBarAxis = d3.axisRight(colorBarScale).ticks(5);

            // Create gradient
            const gradient = svg.append("defs")
                .append("linearGradient")
                .attr("id", `gradient-${svgId}`)
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", 0).attr("y1", colorBarHeight)
                .attr("x2", 0).attr("y2", 0);

            gradient.selectAll("stop")
                .data(colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/(n-1)}%`, color: colorScale(t) })))
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            colorBar.append("rect")
                .attr("width", colorBarWidth)
                .attr("height", colorBarHeight)
                .style("fill", `url(#gradient-${svgId})`);

            colorBar.append("g")
                .attr("transform", `translate(${colorBarWidth}, 0)`)
                .call(colorBarAxis);
        }

        // Update statistics
        function updateStatistics(data) {
            const costOptimal = data.filter(d => d.cost < 0.4).length;
            const sustainOptimal = data.filter(d => d.sustainability > 0.6).length;
            const robust = data.filter(d => d.cost < 0.4 && d.sustainability > 0.6).length;
            
            const costVariation = d3.max(data, d => d.cost) - d3.min(data, d => d.cost);
            
            document.getElementById('optimalRegionCost').textContent = `${Math.round(costOptimal / data.length * 100)}%`;
            document.getElementById('optimalRegionSustain').textContent = `${Math.round(sustainOptimal / data.length * 100)}%`;
            document.getElementById('robustChoices').textContent = robust;
            document.getElementById('maxVariation').textContent = `±${Math.round(costVariation * 50)}%`;
        }

        // Update function
        function updateHeatmaps() {
            const data = generateHeatmapData();
            
            createHeatmap("#costHeatmap", data, d => d.cost, costColorScale, "Cost Analysis");
            createHeatmap("#sustainabilityHeatmap", data, d => d.sustainability, sustainabilityColorScale, "Sustainability Score");
            
            updateStatistics(data);
        }

        // Event listeners
        document.getElementById('basePrice').addEventListener('input', updateHeatmaps);
        document.getElementById('baseCarbonIntensity').addEventListener('input', updateHeatmaps);
        document.getElementById('deviceType').addEventListener('change', updateHeatmaps);
        document.getElementById('workloadType').addEventListener('change', updateHeatmaps);

        // Animation setup
        let animationInterval;
        function setupAnimation() {
            clearInterval(animationInterval);
            const rate = parseInt(document.getElementById('updateRate').value);
            animationInterval = setInterval(() => {
                // Add subtle variations to simulate real-time market changes
                const basePrice = parseFloat(document.getElementById('basePrice').value);
                const variation = (Math.random() - 0.5) * 0.02;
                document.getElementById('basePrice').value = Math.max(0.05, Math.min(0.50, basePrice + variation));
                updateHeatmaps();
            }, rate);
        }

        document.getElementById('updateRate').addEventListener('input', setupAnimation);

        // Initialize
        updateHeatmaps();
        setupAnimation();
    </script>
</body>
</html>